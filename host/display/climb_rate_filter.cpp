#include "climb_rate_filter.h"

namespace airball {

static double filter_taps[CLIMBRATEFILTER_TAP_NUM] = {
    -0.0052842173665807925,
    -0.0006545010365498382,
    -0.0006912820891767174,
    -0.0007269974079106029,
    -0.0007613465327448698,
    -0.0007940926240786449,
    -0.0008250087098166207,
    -0.0008537184883358069,
    -0.0008798240114926597,
    -0.0009030499787607485,
    -0.0009229878328470638,
    -0.0009395204801536603,
    -0.0009525496787432635,
    -0.0009614175342608872,
    -0.000965891055591961,
    -0.000965277028810714,
    -0.0009594691068660345,
    -0.0009487673731670022,
    -0.0009327642819781866,
    -0.0009101698714273512,
    -0.0008806049865147735,
    -0.0008460618251211027,
    -0.0008031660449086304,
    -0.0007536603201540374,
    -0.0006965454881885544,
    -0.000631801723273808,
    -0.000559168164618859,
    -0.0004783299986854203,
    -0.00038899822020566077,
    -0.00029102717925826965,
    -0.00018433748074732017,
    -0.00006870002321595665,
    0.00005632337446634659,
    0.0001904564983618238,
    0.0003346667384673667,
    0.00048795218215203027,
    0.0006509191362224451,
    0.0008240154075614931,
    0.0010068558939551706,
    0.001199140132774042,
    0.0014012754411733396,
    0.0016135256510157957,
    0.0018350658131012837,
    0.002066283582100708,
    0.002306689872110561,
    0.0025563611033440846,
    0.002815190919019298,
    0.003082817084105666,
    0.003358921557207864,
    0.003643269445210908,
    0.003935651179420526,
    0.004235860232180526,
    0.004543411705873032,
    0.004859267786367064,
    0.0051788777751408934,
    0.005508973081235267,
    0.005843128594731582,
    0.006181632821288013,
    0.00652558625751105,
    0.006874584889329819,
    0.007227268189278103,
    0.007582571390481251,
    0.007940027171332277,
    0.008299192421352243,
    0.008660139364422658,
    0.009022525818454495,
    0.009385830965042516,
    0.009749568499343464,
    0.010112638921519219,
    0.010473781410751946,
    0.010831470583898994,
    0.011184320369962992,
    0.011532453847769221,
    0.011879120164758644,
    0.012230318384415564,
    0.012558766620677201,
    0.012891487759062806,
    0.013214797101106322,
    0.013530583600099788,
    0.013838130046212892,
    0.01413687600865856,
    0.014426215752300388,
    0.014705544348610936,
    0.01497427349864917,
    0.015231742095820488,
    0.015477589581445562,
    0.015711569836405776,
    0.015932851781178085,
    0.016141233459492643,
    0.016335690603885948,
    0.016515993120201546,
    0.01668226964264048,
    0.016833970661511967,
    0.016970130277357352,
    0.017090743502164465,
    0.01719667036481524,
    0.017285875077439103,
    0.017359478352767646,
    0.017416745039515357,
    0.017457801560166256,
    0.017482556524118467,
    0.017490840339670896,
    0.017482556524118467,
    0.017457801560166256,
    0.017416745039515357,
    0.017359478352767646,
    0.017285875077439103,
    0.01719667036481524,
    0.017090743502164465,
    0.016970130277357352,
    0.016833970661511967,
    0.01668226964264048,
    0.016515993120201546,
    0.016335690603885948,
    0.016141233459492643,
    0.015932851781178085,
    0.015711569836405776,
    0.015477589581445562,
    0.015231742095820488,
    0.01497427349864917,
    0.014705544348610936,
    0.014426215752300388,
    0.01413687600865856,
    0.013838130046212892,
    0.013530583600099788,
    0.013214797101106322,
    0.012891487759062806,
    0.012558766620677201,
    0.012230318384415564,
    0.011879120164758644,
    0.011532453847769221,
    0.011184320369962992,
    0.010831470583898994,
    0.010473781410751946,
    0.010112638921519219,
    0.009749568499343464,
    0.009385830965042516,
    0.009022525818454495,
    0.008660139364422658,
    0.008299192421352243,
    0.007940027171332277,
    0.007582571390481251,
    0.007227268189278103,
    0.006874584889329819,
    0.00652558625751105,
    0.006181632821288013,
    0.005843128594731582,
    0.005508973081235267,
    0.0051788777751408934,
    0.004859267786367064,
    0.004543411705873032,
    0.004235860232180526,
    0.003935651179420526,
    0.003643269445210908,
    0.003358921557207864,
    0.003082817084105666,
    0.002815190919019298,
    0.0025563611033440846,
    0.002306689872110561,
    0.002066283582100708,
    0.0018350658131012837,
    0.0016135256510157957,
    0.0014012754411733396,
    0.001199140132774042,
    0.0010068558939551706,
    0.0008240154075614931,
    0.0006509191362224451,
    0.00048795218215203027,
    0.0003346667384673667,
    0.0001904564983618238,
    0.00005632337446634659,
    -0.00006870002321595665,
    -0.00018433748074732017,
    -0.00029102717925826965,
    -0.00038899822020566077,
    -0.0004783299986854203,
    -0.000559168164618859,
    -0.000631801723273808,
    -0.0006965454881885544,
    -0.0007536603201540374,
    -0.0008031660449086304,
    -0.0008460618251211027,
    -0.0008806049865147735,
    -0.0009101698714273512,
    -0.0009327642819781866,
    -0.0009487673731670022,
    -0.0009594691068660345,
    -0.000965277028810714,
    -0.000965891055591961,
    -0.0009614175342608872,
    -0.0009525496787432635,
    -0.0009395204801536603,
    -0.0009229878328470638,
    -0.0009030499787607485,
    -0.0008798240114926597,
    -0.0008537184883358069,
    -0.0008250087098166207,
    -0.0007940926240786449,
    -0.0007613465327448698,
    -0.0007269974079106029,
    -0.0006912820891767174,
    -0.0006545010365498382,
    -0.0052842173665807925
};

void climbrateFilter_init(climbrateFilter* f) {
  int i;
  for(i = 0; i < CLIMBRATEFILTER_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void climbrateFilter_put(climbrateFilter* f, double input) {
  f->history[f->last_index++] = input;
  if(f->last_index == CLIMBRATEFILTER_TAP_NUM)
    f->last_index = 0;
}

double climbrateFilter_get(climbrateFilter* f) {
  double acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < CLIMBRATEFILTER_TAP_NUM; ++i) {
    index = index != 0 ? index-1 : CLIMBRATEFILTER_TAP_NUM-1;
    acc += f->history[index] * filter_taps[i];
  };
  return acc;
}

}; // namespace airball